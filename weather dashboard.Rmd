---
title: "Weather Dashboard"
output: flexdashboard::flex_dashboard
runtime: shiny
---

```{r global, include=FALSE}
# Load packages ----
library(shiny);library(shinyWidgets);library(tidyverse);library(plotly);library(zoo);library(lubridate)

source("helpers.R")

# Load data page 1----
weather <- read.csv("data/MYC_MAE.csv") %>% 
  mutate(date = as.yearmon(date),
         Avg_mae = round((MaxTemp_mae+MinTemp_mae)/2, digits = 2),
         MaxTemp = round(MaxTemp, digits = 2),
         MinTemp = round(MinTemp, digits = 2),
         MaxTemp_forecast = round(MaxTemp_forecast, digits = 2),
         MinTemp_forecast = round(MinTemp_forecast, digits = 2))

choices_yearmon <- unique(weather$date)
choices_city <- as.factor(append("the USA", as.character(unique(weather$city))))

#Load data page 2----
weather_rain <- read.csv("data/weather_rain.csv") %>% 
  mutate(RainError = round(RainError, digits = 2))

```

Sidgebar {.sidebar}
===
```{r}
sliderTextInput("month", 
                label = "Month of interest",
                choices = choices_yearmon,
                animate = T
                )

selectInput("city",
            label = "City of Interest",
            choices = choices_city,
            selected = 1)
```

<div style='padding: 3px; width: 230px; word-wrap: break-word;'>
The first page displays Maximum and Minumum Temperatures. Mean Absolute Error (MAE) of the predictions for each city is displayed on the map, by month. The graph on the right shows the plain Max/Min Temps for forecasts and historical measurements for the year.

The second page does the same for rain. Historical rain is measured as a binary variable: more than .01 inches of rain denotes a True. This is contrasted with the forecasted Probability of Precipitation for that day. So the % of days that rained in a month is subtracted from the average probability of precipitation. The graph on the right shows the plain values for the year.
</div>

Page 1
=====

Column {data-width=400}
-----------------------------------------

###Chart 1

```{r}
renderPlotly({
  data <- filter(weather, date == input$month)
  weather_map(data, input$month)
  })
```

Column {data-width=600}
--------------
###Chart 2
```{r}
renderPlotly({
      if (input$city == "the USA") {
      data_band_plot <- filter(weather, year == year(as.yearmon(input$month)))
      data_band_plot <- aggregate(cbind(data_band_plot$MaxTemp, data_band_plot$MaxTemp_forecast, 
                                        data_band_plot$MinTemp, data_band_plot$MinTemp_forecast) 
                                  ~ data_band_plot$month, 
                                  FUN = mean, na.rm = T) %>% 
                        rename(month = `data_band_plot$month`, MaxTemp = V1, MaxTemp_forecast = V2,
                               MinTemp = V3, MinTemp_forecast = V4) %>% 
                        mutate(MaxTemp = round(MaxTemp, digits = 2),
                               MinTemp = round(MinTemp, digits = 2),
                               MaxTemp_forecast = round(MaxTemp_forecast, digits = 2),
                               MinTemp_forecast = round(MinTemp_forecast, digits = 2))
  } else {
    data_band_plot <- filter(weather, city == input$city, year == year(as.yearmon(input$month)))
  }
  
  band_plot(data_band_plot, input$city, input$month)
})
```















Page 2
====

Column {data-width=400}
-----------------------------------------

###Chart 1

```{r}
renderPlotly({
  data <- filter(weather_rain, date == input$month)
  weather_map_rain(data, input$month)
  })
```

Column {data-width=600}
--------------
###Chart 2
```{r}
renderPlotly({
      if (input$city == "the USA") {
      data_band_plot <- filter(weather_rain, year == year(as.yearmon(input$month)))
      data_band_plot <- aggregate(cbind(data_band_plot$PropRain, data_band_plot$ProbPrecip) 
                                  ~ data_band_plot$month, 
                                  FUN = mean, na.rm = T) %>% 
                        rename(month = `data_band_plot$month`, PropRain = V1, ProbPrecip = V2) %>% 
                        mutate(PropRain = round(PropRain, digits = 2),
                               ProbPrecip = round(ProbPrecip, digits = 2))
  } else {
    data_band_plot <- filter(weather_rain, city == input$city, year == year(as.yearmon(input$month)))
  }
  
  band_plot_rain(data_band_plot, input$city, input$month)
})
```
